version = 1

[install]

[vars]
IOS_SIM_DEVICE = "iPhone 13"
IOS_RUNTIME = "15.0"
IOS_SIMULATOR_SERVICE = "ios-simulator-min"

[hook]

[profile]

[services]
ios-simulator-min.command = """
bash -lc '
set -euo pipefail

if ! command -v xcodebuild >/dev/null 2>&1 || ! command -v xcrun >/dev/null 2>&1; then
  echo "Xcode is required. Install Xcode.app and run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer" >&2
  exit 1
fi

runtime_pref="${IOS_RUNTIME:-}"
device_name="${IOS_SIM_DEVICE:-iPhone 13}"

resolve_runtime() {
  python3 - <<'PY' "$runtime_pref"
import json, subprocess, sys
pref = sys.argv[1].strip()
raw = subprocess.check_output(["xcrun", "simctl", "list", "runtimes", "-j"]).decode()
obj = json.loads(raw)
rt = [r for r in obj.get("runtimes", []) if r.get("isAvailable") and r.get("name", "").startswith("iOS ")]
if not rt:
    sys.exit(1)
if pref:
    for r in rt:
        if r.get("identifier") == pref:
            print(r.get("identifier"))
            return
    for r in rt:
        if r.get("name", "").startswith(f"iOS {pref}"):
            print(r.get("identifier"))
            return
    sys.exit(2)
rt.sort(key=lambda r: r.get("version", ""))
print(rt[-1].get("identifier"))
PY
}

runtime_id=""
if runtime_id=$(resolve_runtime); then
  :
else
  if [ "${IOS_DOWNLOAD_RUNTIME:-0}" != "0" ]; then
    echo "iOS runtime ${runtime_pref:-latest} not found. Attempting to download via xcodebuild..." >&2
    xcodebuild -downloadPlatform iOS || true
    runtime_id=$(resolve_runtime || true)
  fi
fi

if [ -z "$runtime_id" ]; then
  echo "No iOS simulator runtime available. Install it in Xcode (Settings > Platforms)." >&2
  exit 1
fi

device_type=$(python3 - <<'PY' "$device_name"
import json, subprocess, sys
name = sys.argv[1].strip().lower()
raw = subprocess.check_output(["xcrun", "simctl", "list", "devicetypes", "-j"]).decode()
obj = json.loads(raw)
for d in obj.get("devicetypes", []):
    if d.get("name", "").lower() == name:
        print(d.get("identifier"))
        break
PY
)
if [ -z "$device_type" ]; then
  echo "Unknown iOS device type: ${device_name}" >&2
  exit 1
fi

existing_udid=$(python3 - <<'PY' "$device_name" "$runtime_id"
import json, subprocess, sys
name, runtime = sys.argv[1], sys.argv[2]
raw = subprocess.check_output(["xcrun", "simctl", "list", "devices", "-j"]).decode()
obj = json.loads(raw)
for dev in obj.get("devices", {}).get(runtime, []):
    if dev.get("name") == name:
        print(dev.get("udid"))
        break
PY
)

if [ -z "$existing_udid" ]; then
  existing_udid=$(xcrun simctl create "$device_name" "$device_type" "$runtime_id")
fi

xcrun simctl boot "$existing_udid" >/dev/null 2>&1 || true
'
"""

[include]
environments = [
    { dir = "../common" },
    { dir = "../../nodejs" }
]

[build]

[options]
