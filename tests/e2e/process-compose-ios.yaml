version: "0.5"

log_location: "test-results/ios-repo-e2e-logs"
log_level: info

environment:
  - "IOS_DEVICE=${IOS_DEVICE:-max}"
  - "IOS_APP_BUNDLE_ID=${IOS_APP_BUNDLE_ID:-com.example.ios}"
  - "BOOT_TIMEOUT=${BOOT_TIMEOUT:-120}"

processes:
  # Verify simulator exists
  verify-simulator:
    command: |
      cd ../examples/ios
      echo "Verifying simulator exists..."
      devbox run ios.sh devices sync
    working_dir: "."
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: "xcrun simctl list devices | grep -q iPhone"
      initial_delay_seconds: 2
      period_seconds: 2
      timeout_seconds: 60
      success_threshold: 1

  # Build iOS app (runs in parallel with simulator verification)
  build-app:
    command: |
      cd ../examples/ios
      echo "Building iOS app..."
      devbox run build:ios
    working_dir: "."
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: "test -d ../examples/ios/.devbox/virtenv/ios/DerivedData/Build/Products/Debug-iphonesimulator/ios.app"
      initial_delay_seconds: 5
      period_seconds: 5
      timeout_seconds: 300
      success_threshold: 1

  # Start iOS simulator
  ios-simulator:
    command: |
      cd ../examples/ios
      echo "Starting iOS simulator..."
      devbox run start:sim "${IOS_DEVICE}"
    working_dir: "."
    depends_on:
      verify-simulator:
        condition: process_completed_successfully
    availability:
      restart: "no"
    shutdown:
      signal: 15
      timeout_seconds: 20
    readiness_probe:
      exec:
        command: "xcrun simctl list devices booted | grep -q Booted"
      initial_delay_seconds: 5
      period_seconds: 3
      timeout_seconds: 120
      success_threshold: 1
    liveness_probe:
      exec:
        command: "xcrun simctl list devices booted | grep -q Booted"
      initial_delay_seconds: 10
      period_seconds: 10
      timeout_seconds: 5

  # Deploy app to simulator
  deploy-app:
    command: |
      cd ../examples/ios
      echo "Deploying app to simulator..."
      devbox run start:ios "${IOS_DEVICE}"
    working_dir: "."
    depends_on:
      ios-simulator:
        condition: process_healthy
      build-app:
        condition: process_completed_successfully
    availability:
      restart: "no"
    readiness_probe:
      exec:
        command: |
          BOOTED_UDID=$(xcrun simctl list devices booted | grep -o '[0-9A-F-]\{36\}' | head -1)
          test -n "$BOOTED_UDID" && xcrun simctl get_app_container booted ${IOS_APP_BUNDLE_ID} >/dev/null 2>&1
      initial_delay_seconds: 5
      period_seconds: 3
      timeout_seconds: 60
      success_threshold: 1

  # Verify app is running
  verify-app:
    command: |
      cd ../examples/ios
      echo "Verifying app is installed..."
      BOOTED_UDID=$(xcrun simctl list devices booted | grep -o '[0-9A-F-]\{36\}' | head -1)
      if [ -z "$BOOTED_UDID" ]; then
        echo "✗ No booted simulator found"
        exit 1
      fi

      # Check if app is installed
      if xcrun simctl get_app_container booted ${IOS_APP_BUNDLE_ID} >/dev/null 2>&1; then
        echo "✓ App bundle found: ${IOS_APP_BUNDLE_ID}"
        echo "✓ App is installed on simulator"
        exit 0
      else
        echo "✗ App bundle not found"
        exit 1
      fi
    working_dir: "."
    depends_on:
      deploy-app:
        condition: process_completed_successfully
    availability:
      restart: "no"

  # Cleanup
  cleanup:
    command: |
      cd ../examples/ios
      echo "Cleaning up..."
      devbox run stop:sim || true
      echo "✓ Cleanup complete"
    working_dir: "."
    depends_on:
      verify-app:
        condition: process_completed
    availability:
      restart: "no"

  # Summary
  summary:
    command: |
      echo ""
      echo "========================================"
      echo "  iOS E2E Test Complete"
      echo "========================================"
      echo ""
      echo "Results:"
      echo "  ✓ Simulator verified"
      echo "  ✓ App build"
      echo "  ✓ Simulator started"
      echo "  ✓ App deployed"
      echo "  ✓ App verified"
      echo ""
      echo "Logs: test-results/ios-repo-e2e-logs"
      echo ""
    depends_on:
      cleanup:
        condition: process_completed
    availability:
      restart: "no"
